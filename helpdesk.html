<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Karachi Board Chat Portal</title>
  <style>
    /* Reset & styling */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family:'Poppins',sans-serif; background:#e8f5e9; height:100vh; display:flex; flex-direction:column; }
    header { background:#169116; color:#fff; text-align:center; padding:16px; font-size:1.6rem; font-weight:600; }
    main { flex:1; display:flex; justify-content:center; padding:10px; overflow:hidden; }

    /* LOGIN */
    #login-section {
      background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.1);
      max-width:360px; width:100%; padding:30px; text-align:center;
    }
    #login-section p { margin-bottom:20px; color:#169116; font-size:1.1rem; font-weight:600; }
    #access-code {
      width:100%; padding:14px; border:2px solid #169116; border-radius:25px;
      font-size:1rem; margin-bottom:12px; outline:none; transition:border 0.3s;
    }
    #access-code:focus { border-color:#0e6b0e; box-shadow:0 0 8px #0e6b0e33; }
    #login-btn {
      width:100%; background:#169116; color:white; padding:14px;
      border:none; border-radius:25px; font-size:1rem; font-weight:600; cursor:pointer;
      transition:background 0.3s;
    }
    #login-btn:hover { background:#0e6b0e; }
    #login-error {
      margin-top:12px; color:#b71c1c; display:none; font-weight:600;
    }

    /* CHAT */
    #chat-section {
      display:none; flex-direction:column; max-width:600px; width:100%;
      background:#fff; border-radius:12px 12px 0 0; box-shadow:0 -4px 20px rgba(0,0,0,0.1);
      position:relative; flex:1;
    }
    #online-users { padding:16px; color:#4e7d4e; font-weight:600; font-size:14px; }

    #messages {
      flex:1; overflow-y:auto; padding:16px;
      display:flex; flex-direction:column; gap:12px;
      scrollbar-width:thin; scrollbar-color:#a5d6a7 transparent;
    }
    #messages::-webkit-scrollbar { width:6px; }
    #messages::-webkit-scrollbar-thumb { background:#a5d6a7; border-radius:3px; }

    .message-wrapper { display:flex; flex-direction:column; max-width:75%; }
    .message-wrapper.left { align-self:flex-start; }
    .message-wrapper.right { align-self:flex-end; }

    .username { font-size:13px; font-weight:600; margin-bottom:4px; color:#555; }
    .bubble {
      padding:12px 16px; border-radius:18px; font-size:15px; position:relative;
      line-height:1.4;
    }
    .left .bubble {
      background:#f1f8e9; color:#2e2e2e; border-bottom-left-radius:3px;
    }
    .right .bubble {
      background:linear-gradient(135deg,#81d4fa,#fffde7);
      color:#004d40; border-bottom-right-radius:3px;
    }
    .sender-KuchuPrincess.right .bubble {
      background:linear-gradient(135deg,#ffecb3,#ffe0b2);
      color:#bf360c;
    }

    .timestamp {
      font-size:11px; margin-top:4px; color:#888;
    }
    .right .timestamp { color:#5a8c5a; }

    #welcome-message {
      text-align:center; font-style:italic; color:#888; margin:20px 0;
    }

    #chat-form {
      display:flex; padding:12px 16px; border-top:1px solid #e0e0e0; gap:12px;
    }
    #message-input {
      flex:1; padding:12px 16px; border:1.5px solid #ccc;
      border-radius:22px; outline:none; font-size:15px;
      transition:border 0.3s;
    }
    #message-input:focus { border-color:#169116; box-shadow:0 0 6px #16911633; }

    #emoji-btn { font-size:22px; background:none; border:none; cursor:pointer; color:#555; }
    #emoji-btn:hover { color:#169116; }

    #send-btn {
      background:#169116; color:white; border:none;
      padding:12px 20px; border-radius:22px; font-size:15px;
      font-weight:600; cursor:pointer; transition:opacity 0.3s;
    }
    #send-btn:disabled { background:#a5d6a7; cursor:default; opacity:0.6; }

    #emoji-picker {
      position:absolute; bottom:70px; left:20px;
      background:#fff; border:1px solid #ccc; border-radius:16px;
      padding:10px; display:none; flex-wrap:wrap; gap:8px;
      box-shadow:0 4px 16px rgba(0,0,0,0.17); z-index:20;
    }
    #emoji-picker span {
      font-size:20px; cursor:pointer; padding:4px 6px; border-radius:6px;
    }
    #emoji-picker span:hover { background:#f5f5f5; }

    #emergency-btn {
      position:absolute; top:18px; right:18px;
      background:#ef5350; color:#fff; border:none;
      padding:8px 16px; border-radius:24px;
      font-size:14px; font-weight:700; cursor:pointer;
      box-shadow:0 3px 8px rgba(237,83,80,0.8); z-index:15;
    }
    #emergency-btn:hover { background:#c62828; }

    #lectures-section {
      display:none; text-align:center; padding:40px 20px;
      max-width:600px; width:100%; color:#333;
    }

    @media(max-width:640px){
      header { font-size:1.4rem; }
      #chat-section, #lectures-section, #login-section { max-width:100%; }
      #messages { padding:12px; }
      #chat-form { padding:10px; }
      .bubble { font-size:14px; }
    }
  </style>
</head>
<body>

<header>Karachi Board Coaching Center Chat Portal</header>

<main>
  <section id="login-section">
    <p>Enter access code to login</p>
    <input id="access-code" type="password" placeholder="Access code" autocomplete="off" />
    <button id="login-btn">Login</button>
    <div id="login-error">Invalid code. Try again.</div>
  </section>

  <section id="chat-section">
    <button id="emergency-btn">Emergency Surge</button>
    <div id="online-users">Online Users: 0</div>
    <div id="messages"></div>
    <form id="chat-form">
      <button type="button" id="emoji-btn">😊</button>
      <input id="message-input" type="text" placeholder="Type a message..." autocomplete="off" />
      <button type="submit" id="send-btn" disabled>Send</button>
    </form>
    <div id="emoji-picker"></div>
  </section>

  <section id="lectures-section">
    <h2>Lecture Materials</h2>
    <p>You’re now logged out.</p>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
      apiKey: "AIzaSyAjhr9440jqm7xk4TISB9LXlU7UMfJ-aYY",
      authDomain: "umama-study-portal.firebaseapp.com",
      projectId: "umama-study-portal",
      storageBucket: "umama-study-portal.firebasestorage.app",
      messagingSenderId: "438854993441",
      appId: "1:438854993441:web:bbe2003382a6bfefbcc560",
    };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const codes = { "ayan123": "Babygurl", "umama123": "KuchuPrincess" };
  let currentUser = null, userRef = null;

  const loginSection = document.getElementById("login-section"),
        chatSection = document.getElementById("chat-section"),
        lectures = document.getElementById("lectures-section"),
        accessField = document.getElementById("access-code"),
        loginBtn = document.getElementById("login-btn"),
        loginErr = document.getElementById("login-error"),
        msgs = document.getElementById("messages"),
        online = document.getElementById("online-users"),
        chatForm = document.getElementById("chat-form"),
        inputField = document.getElementById("message-input"),
        sendBtn = document.getElementById("send-btn"),
        emojiBtn = document.getElementById("emoji-btn"),
        emojiPicker = document.getElementById("emoji-picker"),
        emergencyBtn = document.getElementById("emergency-btn");

  const emojis = ["😀","😂","🫥","😎","👍","😾","🔥","😭","🤔","🙌"];
  emojis.forEach(e => {
    const sp = document.createElement("span");
    sp.textContent = e;
    sp.tabIndex = 0;
    sp.addEventListener("click", () => { insertAt(inputField, e); toggleSend(); });
    emojiPicker.append(sp);
  });

  emojiBtn.addEventListener("click", () => {
    emojiPicker.style.display = emojiPicker.style.display === "flex" ? "none" : "flex";
    emojiPicker.style.flexWrap = "wrap";
  });

  document.addEventListener("click", e => {
    if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
      emojiPicker.style.display = "none";
    }
  });

  function insertAt(el, text) {
    const s = el.selectionStart, e = el.selectionEnd;
    el.value = el.value.slice(0,s) + text + el.value.slice(e);
    el.selectionStart = el.selectionEnd = s + text.length;
    el.focus();
  }

  function toggleSend() {
    sendBtn.disabled = !inputField.value.trim();
  }
  inputField.addEventListener("input", toggleSend);

  function formatTime(ts) {
    const d = new Date(ts);
    let h = d.getHours(), m = d.getMinutes();
    const am = h >=12 ? "PM" : "AM";
    h = h % 12 || 12;
    if (m < 10) m = "0"+m;
    return `${h}:${m} ${am}`;
  }

  function addMsg(m) {
    const w = document.createElement("div");
    w.className = "message-wrapper " + (m.sender===currentUser?"right":"left");
    const u = document.createElement("div");
    u.className="username"; u.textContent=m.sender;
    const b = document.createElement("div");
    b.className="bubble"; b.textContent=m.text;
    const t = document.createElement("div");
    t.className="timestamp"; t.textContent=formatTime(m.timestamp);
    w.append(u,b,t); msgs.append(w);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function clearMsgs() { msgs.innerHTML = ""; }

  function listen() {
    db.ref("messages").off();
    db.ref("messages").on("child_added", snap => addMsg(snap.val()));
  }

  function track() {
    const ref = db.ref("onlineUsers");
    const key = currentUser + Date.now();
    userRef = ref.child(key);
    userRef.set(true);
    userRef.onDisconnect().remove();
    ref.on("value", snap => {
      const v = snap.val()||{};
      online.textContent = "Online Users: "+Object.keys(v).length;
    });
  }

  function showWelcome() {
    const p = document.createElement("p");
    p.id="welcome-message"; p.textContent = `Welcome, ${currentUser}!`;
    msgs.append(p); msgs.scrollTop = msgs.scrollHeight;
  }

  loginBtn.addEventListener("click", () => {
    const code = accessField.value.trim().toLowerCase();
    if (codes[code]) {
      currentUser = codes[code];
      loginErr.style.display = "none";
      loginSection.style.display = "none";
      lectures.style.display = "none";
      chatSection.style.display = "flex";
      clearMsgs();
      showWelcome();
      listen();
      track();
      inputField.value = "";
      toggleSend();
      inputField.focus();
    } else {
      loginErr.style.display = "block";
      accessField.focus();
    }
  });

  chatForm.addEventListener("submit", e => {
    e.preventDefault();
    if (!currentUser) return;
    const txt = inputField.value.trim();
    if (!txt) return;
    db.ref("messages").push({ sender:currentUser, text:txt, timestamp:Date.now() });
    inputField.value = "";
    toggleSend();
    inputField.focus();
  });

  emergencyBtn.addEventListener("click", () => {
    if (userRef) userRef.remove();
    chatSection.style.display = "none";
    lectures.style.display = "block";
    online.textContent = "";
    clearMsgs();
    currentUser = null;
    accessField.value = "";
    loginSection.style.display = "block";
    accessField.focus();
  });

  window.onload = () => accessField.focus();
</script>
</body>
</html>
